name: Build and Push Docker Image

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Generate and export Docker image tag
        id: get-tag
        run: |
          LAST_TAG=$(git tag | grep '^v[0-9]\+$' | sed 's/v//' | sort -n | tail -n 1)
          if [ -z "$LAST_TAG" ]; then
            NEXT_TAG=1
          else
            NEXT_TAG=$((LAST_TAG + 1))
          fi
          echo "NEXT_TAG=v$NEXT_TAG"
          echo "next_tag=v$NEXT_TAG" >> $GITHUB_OUTPUT

      - name: Show build context
        run: ls -l

      - name: Build Docker image with Buildx
        run: |
          echo "Building Docker image with tag: ${{ steps.get-tag.outputs.next_tag }}"
          docker buildx build --load -t ${{ secrets.DOCKER_USERNAME }}/python:${{ steps.get-tag.outputs.next_tag }} .

      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/python:${{ steps.get-tag.outputs.next_tag }}

      - name: Tag and push Git tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag ${{ steps.get-tag.outputs.next_tag }}
          git push origin ${{ steps.get-tag.outputs.next_tag }}
